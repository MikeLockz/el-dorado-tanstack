name: Build and Push

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: self-hosted
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.HARBOR_URL }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Extract Registry Host
        id: registry_host
        run: |
          URL="${{ secrets.HARBOR_URL }}"
          HOST=${URL#*//}
          echo "host=$HOST" >> $GITHUB_OUTPUT

      - name: Build and Push Web
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.web
          push: true
          build-args: |
            VITE_API_URL=${{ secrets.VITE_API_URL }}
            VITE_WS_URL=${{ secrets.VITE_WS_URL }}
          tags: |
            ${{ steps.registry_host.outputs.host }}/el-dorado/web:sha-${{ github.sha }}
            ${{ steps.registry_host.outputs.host }}/el-dorado/web:latest

      - name: Build and Push Server
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.server
          push: true
          tags: |
            ${{ steps.registry_host.outputs.host }}/el-dorado/server:sha-${{ github.sha }}
            ${{ steps.registry_host.outputs.host }}/el-dorado/server:latest

      - name: Update Config Repo
        run: |
          # 1. Clone the Config Repo
          # Note: You need a PAT secret (GH_PAT) to clone another repo
          git clone https://oauth2:${{ secrets.GH_PAT }}@github.com/MikeLockz/lockdev-gitops-registry.git config-repo
          cd config-repo
          
          # 2. Update the tags in the Komodo stack file
          # This replaces ALL 'tag = "..."' with the new SHA. 
          # Since we want both services to update, this is acceptable for now.
          sed -i 's/tag = ".*"/tag = "sha-${{ github.sha }}"/g' stacks/el-dorado.toml
          
          # 3. Commit and Push
          git config user.name "CI Bot"
          git config user.email "ci@internal"
          git add stacks/el-dorado.toml
          git commit -m "Deploy: Update el-dorado to sha-${{ github.sha }}"
          git push