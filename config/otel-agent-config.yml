receivers:
  # 1. Receive Traces/Metrics from your App (e.g. via OTel SDKs)
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

  # 2. Collect Host Metrics (Replaces Node Exporter)
  hostmetrics:
    collection_interval: 30s
    scrapers:
      cpu:
      memory:
      load:
      disk:
      filesystem:
      network:

  # 3. Scrape Prometheus Metrics from MCTS Service
  prometheus:
    config:
      scrape_configs:
        - job_name: 'mcts-ai'
          scrape_interval: 5s
          static_configs:
            - targets: ['mcts-ai:5000']

  # 3. Collect Docker Logs dynamically
  receiver_creator:
    watch_observers: [docker_observer]
    receivers:
      filelog:
        rule: type == "container"
        config:
          include:
            - /var/lib/docker/containers/`container_id`/*.log
          start_at: end
          include_file_path: true
          include_file_name: false
          operators:
            - type: json_parser
              parse_from: body
              parse_to: body
              timestamp:
                parse_from: body.time
                layout: '%Y-%m-%dT%H:%M:%S.%LZ'
            # Move the Docker log content to the body
            - type: move
              from: body.log
              to: body
            # Add container metadata to attributes (resource operator not supported in this context)
            - type: add
              field: attributes["service.name"]
              value: '`name`'
            - type: add
              field: attributes["container.name"]
              value: '`name`'
            - type: add
              field: attributes["container.image.name"]
              value: '`image`'
            - type: add
              field: attributes["container.id"]
              value: '`container_id`'

extensions:
  docker_observer:
    endpoint: "unix:///var/run/docker.sock"

processors:
  batch:
    timeout: 5s
    send_batch_size: 500
    send_batch_max_size: 500
  # Add metadata so you know which server this came from
  resourcedetection:
    detectors: [system, docker]
    timeout: 2s
    override: false
  resource:
    attributes:
      - key: service.namespace
        value: "el-dorado" # Group your services
        action: upsert

exporters:
  # Export EVERYTHING to your Observability Stack
  otlp:
    endpoint: "${OBSERVABILITY_LXC_IP}:4317" # The IP of your other machine
    tls:
      insecure: true

service:
  extensions: [docker_observer]
  pipelines:
    traces:
      receivers: [otlp]
      processors: [resourcedetection, resource, batch]
      exporters: [otlp]
    metrics:
      receivers: [otlp, hostmetrics, prometheus]
      processors: [resourcedetection, resource, batch]
      exporters: [otlp]
    logs:
      receivers: [receiver_creator]
      processors: [resourcedetection, resource, batch]
      exporters: [otlp]
